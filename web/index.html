<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Neo Dining</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Apple Design System Colors */
      --bg-body: #f5f5f7;
      --bg-card: #ffffff;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --danger: #ff3b30;
      
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #000000;
        --bg-card: #1c1c1e;
        --text-primary: #f5f5f7;
        --text-secondary: #86868b;
        --accent: #2997ff;
        --accent-hover: #0071e3;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
        --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
      }
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-primary);
      line-height: 1.4;
      padding-bottom: 100px;
    }

    .shell {
      max-width: 980px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 60px;
      animation: fadeIn 0.8s ease-out;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.005em;
      margin: 0 0 12px;
    }
    
    .subtitle {
      font-size: 21px;
      color: var(--text-secondary);
      font-weight: 400;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Grid */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .card:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    .card-img {
      height: 200px;
      background-color: #f2f2f2;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    /* 生成图片按钮 (Admin shortcut) */
    .gen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .card:hover .gen-btn { opacity: 1; }

    .card-body {
      padding: 24px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 8px;
    }

    .card-price {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .spacer { flex: 1; }

    /* Quantity Control */
    .qty-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-body);
      border-radius: 99px;
      padding: 4px;
    }

    .qty-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: background 0.2s;
    }
    
    .qty-btn:hover { background: rgba(0,0,0,0.05); }
    .qty-btn:active { transform: scale(0.9); }

    .qty-val {
      font-weight: 600;
      font-size: 15px;
      min-width: 24px;
      text-align: center;
    }

    /* Floating Bar */
    .floating-bar {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(150%);
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 24px;
      border-radius: 99px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 24px;
      z-index: 100;
      transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    @media (prefers-color-scheme: dark) {
      .floating-bar {
        background: rgba(28,28,30,0.85);
        border: 1px solid rgba(255,255,255,0.1);
      }
    }

    .floating-bar.show {
      transform: translateX(-50%) translateY(0);
    }

    .total-price {
      font-size: 19px;
      font-weight: 600;
    }

    .checkout-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 99px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    
    .checkout-btn:hover { background: var(--accent-hover); }
    .checkout-btn:active { transform: scale(0.95); }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      background: white;
      color: black;
      padding: 12px 24px;
      border-radius: 99px;
      box-shadow: var(--shadow-md);
      font-weight: 500;
      opacity: 0;
      transition: all 0.4s;
      z-index: 200;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(20px); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="shell">
  <header>
    <h1>Menu</h1>
    <div class="subtitle">精心烹饪的美味，现已触手可及。</div>
  </header>

  <div id="status" style="text-align:center; color:var(--text-secondary); margin-bottom:20px; font-size:14px;"></div>

  <div class="menu-grid" id="menuGrid">
    </div>
</div>

<div class="floating-bar" id="floatBar">
  <div class="total-price" id="totalDisplay">¥0.00</div>
  <button class="checkout-btn" id="orderBtn">立即下单</button>
</div>

<div class="toast" id="toast">Order Placed</div>

<script>
(function() {
  const API_BASE = ''; 
  const state = { menu: {}, cart: {} }; // cart: { name: count }
  
  const els = {
    grid: document.getElementById('menuGrid'),
    bar: document.getElementById('floatBar'),
    total: document.getElementById('totalDisplay'),
    orderBtn: document.getElementById('orderBtn'),
    toast: document.getElementById('toast'),
    status: document.getElementById('status')
  };

  function showToast(msg, isError) {
    els.toast.textContent = msg;
    els.toast.style.color = isError ? '#ff3b30' : '#1d1d1f';
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 3000);
  }

  async function fetchMenu() {
    try {
      els.status.innerText = '正在加载菜单...';
      const res = await fetch(API_BASE + '/menu');
      const data = await res.json();
      if (data.status === 'ok') {
        render(data.menu);
        els.status.innerText = '';
      } else {
        throw new Error(data.message);
      }
    } catch (e) {
      els.status.innerText = '无法连接到服务器，请检查后端是否启动。';
      console.error(e);
    }
  }

  // Admin function to trigger local image generation
  window.genImage = async function(name) {
    try {
      showToast('正在生成图片...', false);
      const res = await fetch(API_BASE + `/admin/menu/${name}/gen-image`, { method: 'POST' });
      const data = await res.json();
      if (data.status === 'ok') {
        render(data.menu); // re-render to show new image
        showToast('图片更新成功');
      }
    } catch (e) {
      showToast('生成失败', true);
    }
  };

  function render(menu) {
    state.menu = menu;
    els.grid.innerHTML = '';
    
    Object.keys(menu).forEach(name => {
      const item = menu[name];
      const price = typeof item === 'number' ? item : item.price;
      const img = (typeof item === 'object' && item.image) ? item.image : null;
      
      const count = state.cart[name] || 0;
      
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-img" style="${img ? `background-image:url('${img}')` : ''}">
          <button class="gen-btn" onclick="genImage('${name}')">生成封面</button>
        </div>
        <div class="card-body">
          <div class="card-title">${name}</div>
          <div class="card-price">¥${price.toFixed(2)}</div>
          <div class="spacer"></div>
          <div class="qty-control">
            <button class="qty-btn" onclick="updateCart('${name}', -1)">−</button>
            <span class="qty-val">${count}</span>
            <button class="qty-btn" onclick="updateCart('${name}', 1)">＋</button>
          </div>
        </div>
      `;
      els.grid.appendChild(el);
    });
    
    updateTotal();
  }

  window.updateCart = function(name, delta) {
    const current = state.cart[name] || 0;
    const next = Math.max(0, current + delta);
    if (next === 0) delete state.cart[name];
    else state.cart[name] = next;
    
    // update specific UI number without re-rendering all
    render(state.menu);
  };

  function updateTotal() {
    let sum = 0;
    let count = 0;
    Object.keys(state.cart).forEach(name => {
      const q = state.cart[name];
      const p = (typeof state.menu[name] === 'object') ? state.menu[name].price : state.menu[name];
      sum += q * p;
      count += q;
    });
    
    els.total.innerText = '¥' + sum.toFixed(2);
    if (count > 0) els.bar.classList.add('show');
    else els.bar.classList.remove('show');
  }

  els.orderBtn.onclick = async () => {
    const items = [];
    Object.keys(state.cart).forEach(name => {
      for(let i=0; i<state.cart[name]; i++) items.push(name);
    });
    
    els.orderBtn.disabled = true;
    els.orderBtn.innerText = '处理中...';
    
    try {
      const res = await fetch(API_BASE + '/order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      if(data.status === 'ok') {
        showToast('下单成功！Total: ¥' + data.total, false);
        state.cart = {};
        render(state.menu);
      } else {
        showToast(data.message, true);
      }
    } catch(e) {
      showToast('网络错误', true);
    }
    
    els.orderBtn.disabled = false;
    els.orderBtn.innerText = '立即下单';
  };

  fetchMenu();
})();
</script>
</body>
</html>